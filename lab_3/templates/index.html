<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лабораторная 3: Базовые алгоритмы</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f4f4f9; }
        #sidebar { width: 320px; padding: 20px; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow-y: auto; }
        #main { flex-grow: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; background-color: #e0e0e0; }
        canvas { background: white; box-shadow: 0 0 10px rgba(0,0,0,0.2); }

        h2 { color: #333; margin-top: 0; }
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        input, select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        .coord-row { display: flex; gap: 5px; }

        button { width: 100%; padding: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; margin-bottom: 5px; }
        button.clear { background-color: #f44336; }
        button:hover { opacity: 0.9; }

        .result-box { margin-top: 20px; padding: 10px; background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 4px; font-size: 0.9rem; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Настройки</h2>

    <div class="control-group">
        <label>Алгоритм:</label>
        <select id="algorithm" onchange="toggleInputs()">
            <option value="step">Пошаговый алгоритм</option>
            <option value="dda">Алгоритм ЦДА</option>
            <option value="bresenham_line">Брезенхем (Линия)</option>
            <option value="bresenham_circle">Брезенхем (Окружность)</option>
            <option value="castle_pitteway">Алгоритм Кастла-Питвея</option>
            <option value="wu">Алгоритм Ву (Сглаживание)</option>
        </select>
    </div>

    <!-- Координаты для линий -->
    <div id="line-inputs">
        <div class="control-group">
            <label>Начало (X1, Y1):</label>
            <div class="coord-row">
                <input type="number" id="x1" value="-10">
                <input type="number" id="y1" value="-10">
            </div>
        </div>
        <div class="control-group">
            <label>Конец (X2, Y2):</label>
            <div class="coord-row">
                <input type="number" id="x2" value="10">
                <input type="number" id="y2" value="5">
            </div>
        </div>
    </div>

    <!-- Для окружности -->
    <div id="circle-inputs" class="hidden">
        <div class="control-group">
            <label>Центр (X1, Y1):</label>
            <div class="coord-row">
                <input type="number" id="c_x" value="0">
                <input type="number" id="c_y" value="0">
            </div>
        </div>
        <div class="control-group">
            <label>Радиус (R):</label>
            <input type="number" id="radius" value="15">
        </div>
    </div>

    <div class="control-group">
        <label>Масштаб: <span id="scaleVal">20</span></label>
        <input type="range" id="scale" min="5" max="50" value="20" oninput="updateScale(this.value)">
    </div>

    <button onclick="runAlgorithm()">Построить</button>
    <button class="clear" onclick="clearCanvas()">Очистить</button>

    <div class="result-box" id="result">
        Время: - <br> Точек: -
    </div>
</div>

<div id="main">
    <canvas id="canvas"></canvas>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let scale = 20;
    let width, height, originX, originY;

    function resizeCanvas() {
        const main = document.getElementById('main');
        canvas.width = main.clientWidth;
        canvas.height = main.clientHeight;
        width = canvas.width;
        height = canvas.height;
        originX = Math.round((width / 2) / scale) * scale;
        originY = Math.round((height / 2) / scale) * scale;
        drawGrid();
    }

    window.addEventListener('resize', resizeCanvas);

    function updateScale(val) {
        scale = parseInt(val);
        document.getElementById('scaleVal').innerText = scale;
        resizeCanvas();
    }

    function toggleInputs() {
        const algo = document.getElementById('algorithm').value;
        const lineInputs = document.getElementById('line-inputs');
        const circleInputs = document.getElementById('circle-inputs');

        lineInputs.classList.add('hidden');
        circleInputs.classList.add('hidden');

        if (algo === 'bresenham_circle') {
            circleInputs.classList.remove('hidden');
        } else {
            lineInputs.classList.remove('hidden');
        }
    }

    function drawGrid() {
        ctx.clearRect(0, 0, width, height);
        ctx.beginPath();
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 1;

        for (let x = originX % scale; x < width; x += scale) {
            ctx.moveTo(x, 0); ctx.lineTo(x, height);
        }
        for (let y = originY % scale; y < height; y += scale) {
            ctx.moveTo(0, y); ctx.lineTo(width, y);
        }
        ctx.stroke();

        ctx.beginPath();
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        ctx.moveTo(0, originY); ctx.lineTo(width, originY);
        ctx.moveTo(originX, 0); ctx.lineTo(originX, height);
        ctx.stroke();
    }

    function drawPixel(logicX, logicY, alpha = 1.0, colorBase = '33, 150, 243') {
        const screenX = originX + (logicX * scale);
        const screenY = originY - (logicY * scale) - scale;

        ctx.fillStyle = `rgba(${colorBase}, ${alpha})`;
        ctx.fillRect(screenX + 1, screenY + 1, scale - 2, scale - 2);
    }

    async function runAlgorithm() {
        const algo = document.getElementById('algorithm').value;
        let payload = {
            algorithm: algo, x1: 0, y1: 0, x2: 0, y2: 0,
            radius: 0
        };

        if (algo === 'bresenham_circle') {
            payload.x1 = parseInt(document.getElementById('c_x').value);
            payload.y1 = parseInt(document.getElementById('c_y').value);
            payload.radius = parseInt(document.getElementById('radius').value);
        } else {
            payload.x1 = parseInt(document.getElementById('x1').value);
            payload.y1 = parseInt(document.getElementById('y1').value);
            payload.x2 = parseInt(document.getElementById('x2').value);
            payload.y2 = parseInt(document.getElementById('y2').value);
        }

        try {
            const response = await fetch('/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();

            clearCanvas();

            // Рисуем точки
            data.points.forEach(p => {
                drawPixel(p[0], p[1], p[2]);
            });

            // Маркеры начала и конца
            drawPixel(payload.x1, payload.y1, 1.0, '244, 67, 54');
            if (algo !== 'bresenham_circle') {
                drawPixel(payload.x2, payload.y2, 1.0, '244, 67, 54');
            }

            let timeStr = data.execution_time_ns < 1000 ? data.execution_time_ns + " нс" :
                          data.execution_time_ns < 1000000 ? (data.execution_time_ns/1000).toFixed(2) + " мкс" :
                          (data.execution_time_ns/1000000).toFixed(4) + " мс";

            document.getElementById('result').innerHTML = `Время (Backend): <b>${timeStr}</b><br>Точек: ${data.points.length}`;

        } catch (e) {
            console.error(e);
            alert("Ошибка расчета");
        }
    }

    function clearCanvas() {
        drawGrid();
        document.getElementById('result').innerHTML = "Время: - <br> Точек: -";
    }

    resizeCanvas();
    toggleInputs();
</script>

</body>
</html>